{"version":3,"sources":["../server/server.js"],"names":[],"mappings":"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","file":"server.js","sourcesContent":["/* eslint no-console: 0 */\r\n\r\nconst express = require(\"express\");\r\nconst path = require(\"path\");\r\nconst webpack = require('webpack');\r\nconst webpackMiddleware = require('webpack-dev-middleware');\r\nconst webpackHotMiddleware = require('webpack-hot-middleware');\r\nconst config = require('../webpack.config.js');\r\nconst bodyParser = require(\"body-parser\");\r\nconst message = require('./message.js');\r\nconst image = require('./image.js');\r\nconst db = require(\"./db.js\");\r\nimport makeStore from \"./store.js\";\r\nimport startServer from './socketing.js';\r\nimport startAdminServer from './adminsocketing.js';\r\n\r\nconst store = makeStore();\r\nstore.dispatch({type:\"INIT\"});\r\nstartServer(store);\r\n\r\nconst adminStore = makeStore();\r\nadminStore.dispatch({type:\"INIT\"});\r\nstartAdminServer(adminStore);\r\n\r\nconst PARENT_DIR = path.join(__dirname, '..');\r\n\r\nconst isDeveloping = (process.env.NODE_ENV || \"\").trim() !== \"production\";\r\nconst port = isDeveloping ? 3001 : process.env.PORT;\r\nconst app = express();\r\n\r\nconst IMAGE_PATH = process.env.CELEB_IMAGE_PATH;\r\n\r\nconst multer = require('multer'); // v1.0.5\r\nvar upload = multer(\r\n  {\r\n    storage: multer.diskStorage({\r\n      destination: function (req, file, cb) {\r\n        cb(null, path.join(PARENT_DIR, 'public', 'images'));\r\n      },\r\n      filename: function(req, file, cb) {\r\n        var ext = path.extname(file.originalname);\r\n        cb(null, Date.now() + ext);\r\n      }\r\n    }),\r\n    limits: { fieldSize: 6000000, files: 1 }\r\n  }\r\n); // for parsing multipart/form-data\r\n\r\nconsole.log(\"process.env.NODE_ENV=[\" + process.env.NODE_ENV + \"]\");\r\nconsole.log(\"isDeveloping=\" + isDeveloping);\r\n\r\napp.use(bodyParser.urlencoded({extended:false}));\r\n\r\nif( isDeveloping) {\r\n  console.log(\"Development mode\");\r\n  const compiler = webpack(config);\r\n  const middleware = webpackMiddleware(compiler, {\r\n    publicPath: config.output.publicPath,\r\n    contentBase: 'app',\r\n    stats: {\r\n      colors: true,\r\n      hash: false,\r\n      timings: true,\r\n      chunks: true,\r\n      chunkModules: false,\r\n      modules: false\r\n    }\r\n  });\r\n\r\n  app.use(middleware);\r\n  app.use(webpackHotMiddleware(compiler));\r\n  app.use(express.static(PARENT_DIR + '/public'));\r\n  app.use('/subimage', express.static(IMAGE_PATH));\r\n  app.get('/', function response(req,res) {\r\n    res.write(middleware.fileSystem.readFileSync(path.join(PARENT_DIR, 'dist/index.html')));\r\n    res.end();\r\n  });\r\n  app.get('/admin', function response(req,res) {\r\n    res.write(middleware.fileSystem.readFileSync(path.join(PARENT_DIR, 'dist/admin.html')));\r\n    res.end();\r\n  });\r\n}\r\nelse {\r\n  app.use(express.static(PARENT_DIR + '/dist'));\r\n  app.use(express.static(PARENT_DIR + '/public'));\r\n  app.use('/subimage', express.static(\"C:\\\\dev\\\\celebkiosk\\\\public\\\\images\"));\r\n  app.get('/', function response(req, res) {\r\n    res.sendFile(path.join(PARENT_DIR, \"dist/index.html\"));\r\n  });\r\n  app.get('/admin', function response(req,res) {\r\n    res.sendFile(path.join(PARENT_DIR, \"dist/admin.html\"));\r\n  });\r\n}\r\n\r\n\r\napp.post(\"/kiosk/message\", function(req,res) {\r\n  var msg = req.body.message || \"\";\r\n  msg = msg.trim();\r\n  if(msg.length==0 || msg.length>140) {\r\n    res.send(\"OK\");\r\n    res.end();\r\n    return;\r\n  }\r\n\r\n  message.submit(req, res, msg).then(function() {\r\n      res.send(\"OK\");\r\n      res.end();\r\n  });\r\n});\r\n\r\napp.post(\"/api/message\", function(req,res) {\r\n  var id = req.body.message || \"\";\r\n  var status = req.body.status || 0;\r\n  if(id && status) {\r\n    if(+status===1) {\r\n      message.approve(id).then(function() {\r\n        res.send(\"OK\");\r\n        res.end();\r\n      });\r\n    }\r\n    else if(+status===2) {\r\n      message.reject(id).then(function() {\r\n        res.send(\"OK\");\r\n        res.end();\r\n      });\r\n    }\r\n  }\r\n  else {\r\n    res.send(\"NOTOK\");\r\n    res.end();\r\n  } \r\n});\r\n\r\napp.post(\"/api/image\", function(req,res) {\r\n  var id = req.body.image || \"\";\r\n  var status = req.body.status || 0;\r\n  if(id && status) {\r\n    if(+status===1) {\r\n      image.approve(id).then(function() {\r\n        res.send(\"OK\");\r\n        res.end();\r\n      });\r\n    }\r\n    else if(+status===2) {\r\n      image.reject(id).then(function() {\r\n        res.send(\"OK\");\r\n        res.end();\r\n      });\r\n    }\r\n  }\r\n  else {\r\n    res.send(\"NOTOK\");\r\n    res.end();\r\n  } \r\n});\r\n\r\napp.post(\"/kiosk/image\", upload.single(\"image\"), function(req,res) {\r\n  if(req.file) {\r\n    image.submit(req, res, req.file).then(function() {\r\n      console.log(\"Got file\");\r\n      res.send(\"OK\");\r\n      res.end();\r\n    });\r\n  }\r\n  else {\r\n    console.log(\"no file!\");\r\n    res.send(\"NOT OK\");\r\n  }\r\n});\r\n\r\napp.listen(port, function onStart(err) {\r\n  if(err) {\r\n    console.log(err);\r\n  }\r\n\tconsole.info(\"Server running on port \" + port + \" public path \" + config.output.publicPath);\r\n});\r\n\r\ndb.getLatestApprovedMessages(10).then(function(cursor) {\r\n  cursor.each(function(err, row) {\r\n    console.log(row);\r\n    store.dispatch({type:\"MESSAGE_CHANGES\", changes:row});    \r\n  });\r\n});\r\n\r\ndb.getLatestApprovedImages(5).then(function(cursor) {\r\n  cursor.each(function(err, row) {\r\n    console.log(row);\r\n    store.dispatch({type:\"IMAGE_CHANGES\", changes:row});    \r\n  });\r\n});\r\n\r\ndb.getPendingMessages(50).then(function(cursor) {\r\n  cursor.each(function(err, row) {\r\n    console.log(row);\r\n    adminStore.dispatch({type:\"MESSAGE_CHANGES\", changes:row});    \r\n  });\r\n});\r\n\r\ndb.getPendingImages(30).then(function(cursor) {\r\n  cursor.each(function(err, row) {\r\n    console.log(row);\r\n    adminStore.dispatch({type:\"IMAGE_CHANGES\", changes:row});    \r\n  });\r\n});\r\n"]}