{"version":3,"sources":["../server/server.js"],"names":[],"mappings":";;AAQA;;;;AACA;;;;AACA;;;;;;;;AARA,IAAM,UAAU,QAAQ,SAAR,CAAhB;AACA,IAAM,OAAO,QAAQ,MAAR,CAAb;AACA,IAAM,aAAa,QAAQ,aAAR,CAAnB;AACA,IAAM,UAAU,QAAQ,cAAR,CAAhB;AACA,IAAM,QAAQ,QAAQ,YAAR,CAAd;AACA,IAAM,KAAK,QAAQ,SAAR,CAAX;;;AAKA,IAAM,QAAQ,sBAAd;AACA,MAAM,QAAN,CAAe,EAAE,MAAM,MAAR,EAAf;AACA,yBAAY,KAAZ;;AAEA,IAAM,aAAa,sBAAnB;AACA,WAAW,QAAX,CAAoB,EAAE,MAAM,MAAR,EAApB;AACA,8BAAiB,UAAjB;;AAEA,IAAM,aAAa,KAAK,IAAL,CAAU,SAAV,EAAqB,IAArB,CAAnB;;AAEA,IAAM,eAAe,CAAC,QAAQ,GAAR,CAAY,QAAZ,IAAwB,EAAzB,EAA6B,IAA7B,OAAwC,YAA7D;AACA,IAAM,OAAO,eAAe,IAAf,GAAsB,QAAQ,GAAR,CAAY,SAA/C;AACA,IAAM,MAAM,SAAZ;;AAEA,IAAM,aAAa,QAAQ,GAAR,CAAY,gBAA/B;;AAEA,IAAM,SAAS,QAAQ,QAAR,CAAf,C;AACA,IAAI,SAAS,OACX;AACE,WAAS,OAAO,WAAP,CAAmB;AAC1B,iBAAa,qBAAU,GAAV,EAAe,IAAf,EAAqB,EAArB,EAAyB;AACpC,SAAG,IAAH,EAAS,KAAK,IAAL,CAAU,UAAV,EAAsB,QAAtB,EAAgC,QAAhC,CAAT;AACD,KAHyB;AAI1B,cAAU,kBAAU,GAAV,EAAe,IAAf,EAAqB,EAArB,EAAyB;AACjC,UAAI,MAAM,KAAK,OAAL,CAAa,KAAK,YAAlB,CAAV;AACA,SAAG,IAAH,EAAS,KAAK,GAAL,KAAa,GAAtB;AACD;AAPyB,GAAnB,CADX;AAUE,UAAQ,EAAE,WAAW,OAAb,EAAsB,OAAO,CAA7B;AAVV,CADW,CAAb,C;;AAeA,QAAQ,GAAR,CAAY,2BAA2B,QAAQ,GAAR,CAAY,QAAvC,GAAkD,GAA9D;AACA,QAAQ,GAAR,CAAY,kBAAkB,YAA9B;;AAEA,IAAI,GAAJ,CAAQ,WAAW,UAAX,CAAsB,EAAE,UAAU,KAAZ,EAAtB,CAAR;;AAEA,IAAI,YAAJ,EAAkB;AAAA;AAChB,YAAQ,GAAR,CAAY,kBAAZ;AACA,QAAM,UAAU,QAAQ,SAAR,CAAhB;AACA,QAAM,oBAAoB,QAAQ,wBAAR,CAA1B;AACA,QAAM,uBAAuB,QAAQ,wBAAR,CAA7B;AACA,QAAM,SAAS,QAAQ,sBAAR,CAAf;;AAEA,QAAM,WAAW,QAAQ,MAAR,CAAjB;AACA,QAAM,aAAa,kBAAkB,QAAlB,EAA4B;AAC7C,kBAAY,OAAO,MAAP,CAAc,UADmB;AAE7C,mBAAa,KAFgC;AAG7C,aAAO;AACL,gBAAQ,IADH;AAEL,cAAM,KAFD;AAGL,iBAAS,IAHJ;AAIL,gBAAQ,IAJH;AAKL,sBAAc,KALT;AAML,iBAAS;AANJ;AAHsC,KAA5B,CAAnB;;AAaA,QAAI,GAAJ,CAAQ,UAAR;AACA,QAAI,GAAJ,CAAQ,qBAAqB,QAArB,CAAR;AACA,QAAI,GAAJ,CAAQ,QAAQ,MAAR,CAAe,aAAa,SAA5B,CAAR;AACA,QAAI,GAAJ,CAAQ,WAAR,EAAqB,QAAQ,MAAR,CAAe,UAAf,CAArB;AACA,QAAI,GAAJ,CAAQ,GAAR,EAAa,SAAS,QAAT,CAAkB,GAAlB,EAAuB,GAAvB,EAA4B;AACvC,UAAI,KAAJ,CAAU,WAAW,UAAX,CAAsB,YAAtB,CAAmC,KAAK,IAAL,CAAU,UAAV,EAAsB,iBAAtB,CAAnC,CAAV;AACA,UAAI,GAAJ;AACD,KAHD;AAIA,QAAI,GAAJ,CAAQ,QAAR,EAAkB,SAAS,QAAT,CAAkB,GAAlB,EAAuB,GAAvB,EAA4B;AAC5C,UAAI,KAAJ,CAAU,WAAW,UAAX,CAAsB,YAAtB,CAAmC,KAAK,IAAL,CAAU,UAAV,EAAsB,iBAAtB,CAAnC,CAAV;AACA,UAAI,GAAJ;AACD,KAHD;AA7BgB;AAiCjB,CAjCD,MAkCK;AACH,MAAI,GAAJ,CAAQ,QAAQ,MAAR,CAAe,aAAa,OAA5B,CAAR;AACA,MAAI,GAAJ,CAAQ,QAAQ,MAAR,CAAe,aAAa,SAA5B,CAAR;AACA,MAAI,GAAJ,CAAQ,WAAR,EAAqB,QAAQ,MAAR,CAAe,UAAf,CAArB;AACA,MAAI,GAAJ,CAAQ,GAAR,EAAa,SAAS,QAAT,CAAkB,GAAlB,EAAuB,GAAvB,EAA4B;AACvC,QAAI,QAAJ,CAAa,KAAK,IAAL,CAAU,UAAV,EAAsB,iBAAtB,CAAb;AACD,GAFD;AAGA,MAAI,GAAJ,CAAQ,QAAR,EAAkB,SAAS,QAAT,CAAkB,GAAlB,EAAuB,GAAvB,EAA4B;AAC5C,QAAI,QAAJ,CAAa,KAAK,IAAL,CAAU,UAAV,EAAsB,iBAAtB,CAAb;AACD,GAFD;AAGD;;AAGD,IAAI,IAAJ,CAAS,gBAAT,EAA2B,UAAU,GAAV,EAAe,GAAf,EAAoB;AAC7C,MAAI,MAAM,IAAI,IAAJ,CAAS,OAAT,IAAoB,EAA9B;AACA,QAAM,IAAI,IAAJ,EAAN;AACA,MAAI,IAAI,MAAJ,IAAc,CAAd,IAAmB,IAAI,MAAJ,GAAa,GAApC,EAAyC;AACvC,QAAI,IAAJ,CAAS,IAAT;AACA,QAAI,GAAJ;AACA;AACD;;AAED,UAAQ,MAAR,CAAe,GAAf,EAAoB,GAApB,EAAyB,GAAzB,EAA8B,IAA9B,CAAmC,YAAY;AAC7C,QAAI,IAAJ,CAAS,IAAT;AACA,QAAI,GAAJ;AACD,GAHD;AAID,CAbD;;AAeA,IAAI,IAAJ,CAAS,cAAT,EAAyB,UAAU,GAAV,EAAe,GAAf,EAAoB;AAC3C,MAAI,KAAK,IAAI,IAAJ,CAAS,OAAT,IAAoB,EAA7B;AACA,MAAI,SAAS,IAAI,IAAJ,CAAS,MAAT,IAAmB,CAAhC;AACA,MAAI,MAAM,MAAV,EAAkB;AAChB,QAAI,CAAC,MAAD,KAAY,CAAhB,EAAmB;AACjB,cAAQ,OAAR,CAAgB,EAAhB,EAAoB,IAApB,CAAyB,YAAY;AACnC,YAAI,IAAJ,CAAS,IAAT;AACA,YAAI,GAAJ;AACD,OAHD;AAID,KALD,MAMK,IAAI,CAAC,MAAD,KAAY,CAAhB,EAAmB;AACtB,cAAQ,MAAR,CAAe,EAAf,EAAmB,IAAnB,CAAwB,YAAY;AAClC,YAAI,IAAJ,CAAS,IAAT;AACA,YAAI,GAAJ;AACD,OAHD;AAID;AACF,GAbD,MAcK;AACH,QAAI,IAAJ,CAAS,OAAT;AACA,QAAI,GAAJ;AACD;AACF,CArBD;;AAuBA,IAAI,IAAJ,CAAS,YAAT,EAAuB,UAAU,GAAV,EAAe,GAAf,EAAoB;AACzC,MAAI,KAAK,IAAI,IAAJ,CAAS,KAAT,IAAkB,EAA3B;AACA,MAAI,SAAS,IAAI,IAAJ,CAAS,MAAT,IAAmB,CAAhC;AACA,MAAI,MAAM,MAAV,EAAkB;AAChB,QAAI,CAAC,MAAD,KAAY,CAAhB,EAAmB;AACjB,YAAM,OAAN,CAAc,EAAd,EAAkB,IAAlB,CAAuB,YAAY;AACjC,YAAI,IAAJ,CAAS,IAAT;AACA,YAAI,GAAJ;AACD,OAHD;AAID,KALD,MAMK,IAAI,CAAC,MAAD,KAAY,CAAhB,EAAmB;AACtB,YAAM,MAAN,CAAa,EAAb,EAAiB,IAAjB,CAAsB,YAAY;AAChC,YAAI,IAAJ,CAAS,IAAT;AACA,YAAI,GAAJ;AACD,OAHD;AAID,KALI,MAMA;AACH,UAAI,MAAJ,CAAW,GAAX;AACA,UAAI,IAAJ,CAAS,OAAT;AACA,UAAI,GAAJ;AACD;AACD;AACD;;AAED,MAAI,WAAW,IAAI,IAAJ,CAAS,QAAT,IAAqB,EAApC;AACA,MAAI,OAAO,aAAa,MAAb,IAAuB,aAAa,OAA3C,CAAJ,EAAyD;AACvD,UAAM,MAAN,CAAa,EAAb,EAAiB,aAAa,MAA9B,EAAsC,IAAtC,CAA2C,YAAY;AACrD,UAAI,IAAJ,CAAS,IAAT;AACA,UAAI,GAAJ;AACD,KAHD,EAIG,KAJH,CAIS,UAAU,GAAV,EAAe;AACpB,UAAI,MAAJ,CAAW,GAAX;AACA,UAAI,IAAJ,CAAS,GAAT;AACA,UAAI,GAAJ;AACD,KARH;AASD,GAVD,MAWK;AACH,QAAI,MAAJ,CAAW,GAAX;AACA,QAAI,IAAJ,CAAS,OAAT;AACA,QAAI,GAAJ;AACD;AACF,CAzCD;;AA2CA,IAAI,IAAJ,CAAS,cAAT,EAAyB,OAAO,MAAP,CAAc,OAAd,CAAzB,EAAiD,UAAU,GAAV,EAAe,GAAf,EAAoB;AACnE,MAAI,IAAI,IAAR,EAAc;AACZ,UAAM,MAAN,CAAa,GAAb,EAAkB,GAAlB,EAAuB,IAAI,IAA3B,EAAiC,IAAjC,CAAsC,YAAY;AAChD,cAAQ,GAAR,CAAY,UAAZ;AACA,UAAI,IAAJ,CAAS,IAAT;AACA,UAAI,GAAJ;AACD,KAJD;AAKD,GAND,MAOK;AACH,YAAQ,GAAR,CAAY,UAAZ;AACA,QAAI,IAAJ,CAAS,QAAT;AACD;AACF,CAZD;;AAcA,IAAI,MAAJ,CAAW,IAAX,EAAiB,SAAS,OAAT,CAAiB,GAAjB,EAAsB;AACrC,MAAI,GAAJ,EAAS;AACP,YAAQ,GAAR,CAAY,GAAZ;AACD;AACD,UAAQ,IAAR,CAAa,4BAA4B,IAAzC;AACD,CALD;;AAOA,GAAG,yBAAH,CAA6B,EAA7B,EAAiC,IAAjC,CAAsC,UAAU,MAAV,EAAkB;AACtD,SAAO,IAAP,CAAY,UAAU,GAAV,EAAe,GAAf,EAAoB;AAC9B,YAAQ,GAAR,CAAY,GAAZ;AACA,UAAM,QAAN,CAAe,EAAE,MAAM,iBAAR,EAA2B,SAAS,GAApC,EAAf;AACD,GAHD;AAID,CALD;;AAOA,GAAG,uBAAH,CAA2B,CAA3B,EAA8B,IAA9B,CAAmC,UAAU,MAAV,EAAkB;AACnD,SAAO,IAAP,CAAY,UAAU,GAAV,EAAe,GAAf,EAAoB;AAC9B,YAAQ,GAAR,CAAY,GAAZ;AACA,UAAM,QAAN,CAAe,EAAE,MAAM,eAAR,EAAyB,SAAS,GAAlC,EAAf;AACD,GAHD;AAID,CALD;;AAOA,GAAG,kBAAH,CAAsB,EAAtB,EAA0B,IAA1B,CAA+B,UAAU,MAAV,EAAkB;AAC/C,SAAO,IAAP,CAAY,UAAU,GAAV,EAAe,GAAf,EAAoB;AAC9B,YAAQ,GAAR,CAAY,GAAZ;AACA,eAAW,QAAX,CAAoB,EAAE,MAAM,iBAAR,EAA2B,SAAS,GAApC,EAApB;AACD,GAHD;AAID,CALD;;AAOA,GAAG,gBAAH,CAAoB,EAApB,EAAwB,IAAxB,CAA6B,UAAU,MAAV,EAAkB;AAC7C,SAAO,IAAP,CAAY,UAAU,GAAV,EAAe,GAAf,EAAoB;AAC9B,YAAQ,GAAR,CAAY,GAAZ;AACA,eAAW,QAAX,CAAoB,EAAE,MAAM,eAAR,EAAyB,SAAS,GAAlC,EAApB;AACD,GAHD;AAID,CALD","file":"server.js","sourcesContent":["/* eslint no-console: 0 */\r\n\r\nconst express = require(\"express\");\r\nconst path = require(\"path\");\r\nconst bodyParser = require(\"body-parser\");\r\nconst message = require('./message.js');\r\nconst image = require('./image.js');\r\nconst db = require(\"./db.js\");\r\nimport makeStore from \"./store.js\";\r\nimport startServer from './socketing.js';\r\nimport startAdminServer from './adminsocketing.js';\r\n\r\nconst store = makeStore();\r\nstore.dispatch({ type: \"INIT\" });\r\nstartServer(store);\r\n\r\nconst adminStore = makeStore();\r\nadminStore.dispatch({ type: \"INIT\" });\r\nstartAdminServer(adminStore);\r\n\r\nconst PARENT_DIR = path.join(__dirname, '..');\r\n\r\nconst isDeveloping = (process.env.NODE_ENV || \"\").trim() !== \"production\";\r\nconst port = isDeveloping ? 3001 : process.env.ADMINPORT;\r\nconst app = express();\r\n\r\nconst IMAGE_PATH = process.env.CELEB_IMAGE_PATH;\r\n\r\nconst multer = require('multer'); // v1.0.5\r\nvar upload = multer(\r\n  {\r\n    storage: multer.diskStorage({\r\n      destination: function (req, file, cb) {\r\n        cb(null, path.join(PARENT_DIR, 'public', 'images'));\r\n      },\r\n      filename: function (req, file, cb) {\r\n        var ext = path.extname(file.originalname);\r\n        cb(null, Date.now() + ext);\r\n      }\r\n    }),\r\n    limits: { fieldSize: 6000000, files: 1 }\r\n  }\r\n); // for parsing multipart/form-data\r\n\r\nconsole.log(\"process.env.NODE_ENV=[\" + process.env.NODE_ENV + \"]\");\r\nconsole.log(\"isDeveloping=\" + isDeveloping);\r\n\r\napp.use(bodyParser.urlencoded({ extended: false }));\r\n\r\nif (isDeveloping) {\r\n  console.log(\"Development mode\");\r\n  const webpack = require('webpack');\r\n  const webpackMiddleware = require('webpack-dev-middleware');\r\n  const webpackHotMiddleware = require('webpack-hot-middleware');\r\n  const config = require('../webpack.config.js');\r\n\r\n  const compiler = webpack(config);\r\n  const middleware = webpackMiddleware(compiler, {\r\n    publicPath: config.output.publicPath,\r\n    contentBase: 'app',\r\n    stats: {\r\n      colors: true,\r\n      hash: false,\r\n      timings: true,\r\n      chunks: true,\r\n      chunkModules: false,\r\n      modules: false\r\n    }\r\n  });\r\n\r\n  app.use(middleware);\r\n  app.use(webpackHotMiddleware(compiler));\r\n  app.use(express.static(PARENT_DIR + '/public'));\r\n  app.use('/subimage', express.static(IMAGE_PATH));\r\n  app.get('/', function response(req, res) {\r\n    res.write(middleware.fileSystem.readFileSync(path.join(PARENT_DIR, 'dist/index.html')));\r\n    res.end();\r\n  });\r\n  app.get('/admin', function response(req, res) {\r\n    res.write(middleware.fileSystem.readFileSync(path.join(PARENT_DIR, 'dist/admin.html')));\r\n    res.end();\r\n  });\r\n}\r\nelse {\r\n  app.use(express.static(PARENT_DIR + '/dist'));\r\n  app.use(express.static(PARENT_DIR + '/public'));\r\n  app.use('/subimage', express.static(IMAGE_PATH));\r\n  app.get('/', function response(req, res) {\r\n    res.sendFile(path.join(PARENT_DIR, \"dist/index.html\"));\r\n  });\r\n  app.get('/admin', function response(req, res) {\r\n    res.sendFile(path.join(PARENT_DIR, \"dist/admin.html\"));\r\n  });\r\n}\r\n\r\n\r\napp.post(\"/kiosk/message\", function (req, res) {\r\n  var msg = req.body.message || \"\";\r\n  msg = msg.trim();\r\n  if (msg.length == 0 || msg.length > 140) {\r\n    res.send(\"OK\");\r\n    res.end();\r\n    return;\r\n  }\r\n\r\n  message.submit(req, res, msg).then(function () {\r\n    res.send(\"OK\");\r\n    res.end();\r\n  });\r\n});\r\n\r\napp.post(\"/api/message\", function (req, res) {\r\n  var id = req.body.message || \"\";\r\n  var status = req.body.status || 0;\r\n  if (id && status) {\r\n    if (+status === 1) {\r\n      message.approve(id).then(function () {\r\n        res.send(\"OK\");\r\n        res.end();\r\n      });\r\n    }\r\n    else if (+status === 2) {\r\n      message.reject(id).then(function () {\r\n        res.send(\"OK\");\r\n        res.end();\r\n      });\r\n    }\r\n  }\r\n  else {\r\n    res.send(\"NOTOK\");\r\n    res.end();\r\n  }\r\n});\r\n\r\napp.post(\"/api/image\", function (req, res) {\r\n  var id = req.body.image || \"\";\r\n  var status = req.body.status || 0;\r\n  if (id && status) {\r\n    if (+status === 1) {\r\n      image.approve(id).then(function () {\r\n        res.send(\"OK\");\r\n        res.end();\r\n      });\r\n    }\r\n    else if (+status === 2) {\r\n      image.reject(id).then(function () {\r\n        res.send(\"OK\");\r\n        res.end();\r\n      });\r\n    }\r\n    else {\r\n      res.status(500);\r\n      res.send(\"NOTOK\");\r\n      res.end();\r\n    }\r\n    return;\r\n  }\r\n  // check for rotation instead\r\n  var rotation = req.body.rotation || \"\";\r\n  if (id && (rotation === \"left\" || rotation === \"right\")) {\r\n    image.rotate(id, rotation === \"left\").then(function () {\r\n      res.send(\"OK\");\r\n      res.end();\r\n    })\r\n      .catch(function (err) {\r\n        res.status(500);\r\n        res.send(err);\r\n        res.end();\r\n      });\r\n  }\r\n  else {\r\n    res.status(500);\r\n    res.send(\"NOTOK\");\r\n    res.end();\r\n  }\r\n});\r\n\r\napp.post(\"/kiosk/image\", upload.single(\"image\"), function (req, res) {\r\n  if (req.file) {\r\n    image.submit(req, res, req.file).then(function () {\r\n      console.log(\"Got file\");\r\n      res.send(\"OK\");\r\n      res.end();\r\n    });\r\n  }\r\n  else {\r\n    console.log(\"no file!\");\r\n    res.send(\"NOT OK\");\r\n  }\r\n});\r\n\r\napp.listen(port, function onStart(err) {\r\n  if (err) {\r\n    console.log(err);\r\n  }\r\n  console.info(\"Server running on port \" + port);\r\n});\r\n\r\ndb.getLatestApprovedMessages(10).then(function (cursor) {\r\n  cursor.each(function (err, row) {\r\n    console.log(row);\r\n    store.dispatch({ type: \"MESSAGE_CHANGES\", changes: row });\r\n  });\r\n});\r\n\r\ndb.getLatestApprovedImages(5).then(function (cursor) {\r\n  cursor.each(function (err, row) {\r\n    console.log(row);\r\n    store.dispatch({ type: \"IMAGE_CHANGES\", changes: row });\r\n  });\r\n});\r\n\r\ndb.getPendingMessages(50).then(function (cursor) {\r\n  cursor.each(function (err, row) {\r\n    console.log(row);\r\n    adminStore.dispatch({ type: \"MESSAGE_CHANGES\", changes: row });\r\n  });\r\n});\r\n\r\ndb.getPendingImages(30).then(function (cursor) {\r\n  cursor.each(function (err, row) {\r\n    console.log(row);\r\n    adminStore.dispatch({ type: \"IMAGE_CHANGES\", changes: row });\r\n  });\r\n});\r\n"]}