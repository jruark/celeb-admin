{"version":3,"sources":["../server/server.js"],"names":[],"mappings":"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","file":"server.js","sourcesContent":["/* eslint no-console: 0 */\r\n\r\nconst express = require(\"express\");\r\nconst path = require(\"path\");\r\nconst webpack = require('webpack');\r\nconst webpackMiddleware = require('webpack-dev-middleware');\r\nconst webpackHotMiddleware = require('webpack-hot-middleware');\r\nconst config = require('../webpack.config.js');\r\nconst bodyParser = require(\"body-parser\");\r\nconst message = require('./message.js');\r\nconst image = require('./image.js');\r\nconst db = require(\"./db.js\");\r\nimport makeStore from \"./store.js\";\r\nimport startServer from './socketing.js';\r\nimport startAdminServer from './adminsocketing.js';\r\n\r\nconst store = makeStore();\r\nstore.dispatch({type:\"INIT\"});\r\nstartServer(store);\r\n\r\nconst adminStore = makeStore();\r\nadminStore.dispatch({type:\"INIT\"});\r\nstartAdminServer(adminStore);\r\n\r\nconst PARENT_DIR = path.join(__dirname, '..');\r\n\r\nconst isDeveloping = (process.env.NODE_ENV || \"\").trim() !== \"production\";\r\nconst port = isDeveloping ? 3001 : process.env.PORT;\r\nconst app = express();\r\n\r\nconst multer = require('multer'); // v1.0.5\r\nvar upload = multer(\r\n  {\r\n    storage: multer.diskStorage({\r\n      destination: function (req, file, cb) {\r\n        cb(null, path.join(PARENT_DIR, 'public', 'images'));\r\n      },\r\n      filename: function(req, file, cb) {\r\n        var ext = path.extname(file.originalname);\r\n        cb(null, Date.now() + ext);\r\n      }\r\n    }),\r\n    limits: { fieldSize: 6000000, files: 1 }\r\n  }\r\n); // for parsing multipart/form-data\r\n\r\nconsole.log(\"process.env.NODE_ENV=[\" + process.env.NODE_ENV + \"]\");\r\nconsole.log(\"isDeveloping=\" + isDeveloping);\r\n\r\napp.use(bodyParser.urlencoded({extended:false}));\r\n\r\nif( isDeveloping) {\r\n  console.log(\"Development mode\");\r\n  const compiler = webpack(config);\r\n  const middleware = webpackMiddleware(compiler, {\r\n    publicPath: config.output.publicPath,\r\n    contentBase: 'app',\r\n    stats: {\r\n      colors: true,\r\n      hash: false,\r\n      timings: true,\r\n      chunks: true,\r\n      chunkModules: false,\r\n      modules: false\r\n    }\r\n  });\r\n\r\n  app.use(middleware);\r\n  app.use(webpackHotMiddleware(compiler));\r\n  app.use(express.static(PARENT_DIR + '/public'));\r\n  app.use('/subimage', express.static(\"C:\\\\dev\\\\celebkiosk\\\\public\\\\images\"));\r\n  app.get('/', function response(req,res) {\r\n    res.write(middleware.fileSystem.readFileSync(path.join(PARENT_DIR, 'dist/index.html')));\r\n    res.end();\r\n  });\r\n  app.get('/admin', function response(req,res) {\r\n    res.write(middleware.fileSystem.readFileSync(path.join(PARENT_DIR, 'dist/admin.html')));\r\n    res.end();\r\n  });\r\n}\r\nelse {\r\n  app.use(express.static(PARENT_DIR + '/dist'));\r\n  app.use(express.static(PARENT_DIR + '/public'));\r\n  app.use('/subimage', express.static(\"C:\\\\dev\\\\celebkiosk\\\\public\\\\images\"));\r\n  app.get('/', function response(req, res) {\r\n    res.sendFile(path.join(PARENT_DIR, \"dist/index.html\"));\r\n  });\r\n  app.get('/admin', function response(req,res) {\r\n    res.sendFile(path.join(PARENT_DIR, \"dist/admin.html\"));\r\n  });\r\n}\r\n\r\n\r\napp.post(\"/kiosk/message\", function(req,res) {\r\n  var msg = req.body.message || \"\";\r\n  msg = msg.trim();\r\n  if(msg.length==0 || msg.length>140) {\r\n    res.send(\"OK\");\r\n    res.end();\r\n    return;\r\n  }\r\n\r\n  message.submit(req, res, msg).then(function() {\r\n      res.send(\"OK\");\r\n      res.end();\r\n  });\r\n});\r\n\r\napp.post(\"/api/message\", function(req,res) {\r\n  var id = req.body.message || \"\";\r\n  var status = req.body.status || 0;\r\n  if(id && status) {\r\n    if(+status===1) {\r\n      message.approve(id).then(function() {\r\n        res.send(\"OK\");\r\n        res.end();\r\n      });\r\n    }\r\n    else if(+status===2) {\r\n      message.reject(id).then(function() {\r\n        res.send(\"OK\");\r\n        res.end();\r\n      });\r\n    }\r\n  }\r\n  else {\r\n    res.send(\"NOTOK\");\r\n    res.end();\r\n  } \r\n});\r\n\r\napp.post(\"/api/image\", function(req,res) {\r\n  var id = req.body.image || \"\";\r\n  var status = req.body.status || 0;\r\n  if(id && status) {\r\n    if(+status===1) {\r\n      image.approve(id).then(function() {\r\n        res.send(\"OK\");\r\n        res.end();\r\n      });\r\n    }\r\n    else if(+status===2) {\r\n      image.reject(id).then(function() {\r\n        res.send(\"OK\");\r\n        res.end();\r\n      });\r\n    }\r\n  }\r\n  else {\r\n    res.send(\"NOTOK\");\r\n    res.end();\r\n  } \r\n});\r\n\r\napp.post(\"/kiosk/image\", upload.single(\"image\"), function(req,res) {\r\n  if(req.file) {\r\n    image.submit(req, res, req.file).then(function() {\r\n      console.log(\"Got file\");\r\n      res.send(\"OK\");\r\n      res.end();\r\n    });\r\n  }\r\n  else {\r\n    console.log(\"no file!\");\r\n    res.send(\"NOT OK\");\r\n  }\r\n});\r\n\r\napp.listen(port, function onStart(err) {\r\n  if(err) {\r\n    console.log(err);\r\n  }\r\n\tconsole.info(\"Server running on port \" + port + \" public path \" + config.output.publicPath);\r\n});\r\n\r\ndb.getLatestApprovedMessages(10).then(function(cursor) {\r\n  cursor.each(function(err, row) {\r\n    console.log(row);\r\n    store.dispatch({type:\"MESSAGE_CHANGES\", changes:row});    \r\n  });\r\n});\r\n\r\ndb.getLatestApprovedImages(5).then(function(cursor) {\r\n  cursor.each(function(err, row) {\r\n    console.log(row);\r\n    store.dispatch({type:\"IMAGE_CHANGES\", changes:row});    \r\n  });\r\n});\r\n\r\ndb.getPendingMessages(50).then(function(cursor) {\r\n  cursor.each(function(err, row) {\r\n    console.log(row);\r\n    adminStore.dispatch({type:\"MESSAGE_CHANGES\", changes:row});    \r\n  });\r\n});\r\n\r\ndb.getPendingImages(30).then(function(cursor) {\r\n  cursor.each(function(err, row) {\r\n    console.log(row);\r\n    adminStore.dispatch({type:\"IMAGE_CHANGES\", changes:row});    \r\n  });\r\n});\r\n"]}