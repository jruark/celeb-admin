{"version":3,"sources":["../server/message.js"],"names":[],"mappings":"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","file":"message.js","sourcesContent":["const r = require('rethinkdb');\r\nconst db = require('./db.js');\r\n\r\nvar submitMessage = function(req, res, msgtxt) {\r\n    return new Promise(function(resolve, reject) {\r\n        var msg = {\r\n            msg: msgtxt,\r\n            date: new Date(),\r\n            status: 0,\r\n            ip: req.ip,\r\n            host: req.hostname\r\n        };\r\n        db.connect().then(function(conn) {\r\n        r.table(\"Messages\").insert(msg).run(conn)\r\n            .then(function(dbres) {\r\n                console.log(\"Inserted message [\" + msgtxt + \"] at \" + msg.date);\r\n                resolve(\"OK\");\r\n            })\r\n            .error(function(err) {\r\n                console.error(\"Unable to submit message [\" + msgtxt + \"]. Error: \" + err);\r\n                reject(err);\r\n            });\r\n        });\r\n    });\r\n}\r\n\r\nvar changeStatus = function(msgid, status) {\r\n    return new Promise(function(resolve, reject) {\r\n        db.connect().then(function(conn) {\r\n            r.table(\"Messages\").get(msgid).update({status: status})\r\n                .run(conn)\r\n                .then(function(dbres) {\r\n                    console.log(\"Changed message status [\" + msgid + \"] to \" + status);\r\n                    resolve(\"OK\"); \r\n                })\r\n                .error(function(err) {\r\n                    console.error(\"Unable to update status of message [\" + msgid + \"]. Error: \" + err);\r\n                    reject(err);\r\n                });\r\n        });\r\n    });\r\n}\r\n\r\nvar approveMessage = function(msgid) {\r\n    return changeStatus(msgid, 1);\r\n}\r\n\r\nvar rejectMessage = function(msgid) {\r\n    return changeStatus(msgid, 2);\r\n}\r\n\r\nvar processMessageChanges = function(state, changes) {\r\n    var msglist = state.get(\"Messages\");\r\n    var changed = false;\r\n    if(changes.old_offset || changes.old_offset===0) {\r\n        msglist=msglist.delete(changes.old_offset);\r\n        changed = true;\r\n        console.log(\"Removing message \" + changes.old_offset);\r\n    }\r\n    if(changes.new_offset || changes.new_offset===0) {\r\n        msglist = msglist.insert(changes.new_offset, changes.new_val);\r\n        changed = true;\r\n        console.log(\"Adding message\" + changes.new_offset);\r\n    }\r\n    if(changed) {\r\n        return state.set(\"Messages\", msglist);        \r\n    }\r\n    return state;\r\n}\r\n\r\n\r\nexports.submit = submitMessage;\r\nexports.approve = approveMessage;\r\nexports.reject = rejectMessage;\r\nexports.processMessageChanges = processMessageChanges;"]}