{"version":3,"sources":["../server/message.js"],"names":[],"mappings":"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","file":"message.js","sourcesContent":["const r = require('rethinkdb');\r\nconst db = require('./db.js');\r\n\r\nvar submitMessage = function(req, res, msgtxt) {\r\n    return new Promise(function(resolve, reject) {\r\n        var msg = {\r\n            msg: msgtxt,\r\n            date: new Date(),\r\n            status: 0,\r\n            ip: req.ip,\r\n            host: req.hostname\r\n        };\r\n        db.connect().then(function(conn) {\r\n        r.table(\"Messages\").insert(msg).run(conn)\r\n            .then(function(dbres) {\r\n                console.log(\"Inserted message [\" + msgtxt + \"] at \" + msg.date);\r\n                resolve(\"OK\");\r\n            })\r\n            .error(function(err) {\r\n                console.error(\"Unable to submit message [\" + msgtxt + \"]. Error: \" + err);\r\n                reject(err);\r\n            });\r\n        });\r\n    });\r\n}\r\n\r\nvar changeStatus = function(msgid, status) {\r\n    return new Promise(function(resolve, reject) {\r\n        db.connect().then(function(conn) {\r\n            r.table(\"Messages\").get(msgid).update({status: status})\r\n                .run(conn)\r\n                .then(function(dbres) {\r\n                    console.log(\"Changed message status [\" + msgid + \"] to \" + status);\r\n                    resolve(\"OK\"); \r\n                })\r\n                .error(function(err) {\r\n                    console.error(\"Unable to update status of message [\" + msgid + \"]. Error: \" + err);\r\n                    reject(err);\r\n                });\r\n        });\r\n    });\r\n}\r\n\r\nvar approveMessage = function(msgid) {\r\n    return changeStatus(msgid, 1);\r\n}\r\n\r\nvar rejectMessage = function(msgid) {\r\n    return changeStatus(msgid, 2);\r\n}\r\n\r\nvar processMessageChanges = function(state, changes) {\r\n    var msglist = state.get(\"Messages\");\r\n    var changed = false;\r\n    if(changes.old_offset || changes.old_offset===0) {\r\n        msglist=msglist.delete(changes.old_offset);\r\n        changed = true;\r\n        console.log(\"Removing message \" + changes.old_offset);\r\n    }\r\n    if(changes.new_offset || changes.new_offset===0) {\r\n        msglist = msglist.insert(changes.new_offset, changes.new_val);\r\n        changed = true;\r\n        console.log(\"Adding message\" + changes.new_offset);\r\n    }\r\n    if(changed) {\r\n        return state.set(\"Messages\", msglist);        \r\n    }\r\n    return state;\r\n}\r\n\r\n\r\nexports.submit = submitMessage;\r\nexports.approve = approveMessage;\r\nexports.reject = rejectMessage;\r\nexports.processMessageChanges = processMessageChanges;"]}